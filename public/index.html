<!DOCTYPE html>
<html>

<style type="text/css">
html,
body {
    margin: 0;
    overflow: hidden;
}
canvas {

	margin-left: 2%;	
	margin-right: 8%;
	margin-top: 2%;
	margin-bottom : 8%;
	border-style: solid;
	border-width: 4px;

    width: 1272px;
	height: 632px;
}
</style>

<head>

<script type="text/javascript">
	var ws = new WebSocket('wss://localhost:3250');
</script>
<!-- Load the Paper.js library -->
<script type="text/javascript" src="js/paper.js"></script>
<!-- Define inlined PaperScript associate it with myCanvas -->
<script type="text/paperscript" canvas="myCanvas">
	
	// Départ, couleur et direction aléatoire
	var random = new Point(Math.random()*1272,Math.random()*632);
	var randomColor = new Color(Math.random(),Math.random(),Math.random())
	var headCenter = new Point(100+Math.random()*1072,100+Math.random()*432);
	
	var vector = 0;
	vector = random - headCenter;
	vector.length = speed;
	
	// Tête du serpent
		var circle = new Path.Circle({
		center: headCenter,
		radius: 6,
		fillColor: randomColor
		});
		
	// Variables du jeu
	var speed = 200;
	
	// Construction du serpent par clonage de la tête
	var snake = [circle];
	for(var i = 0; i<10; i++)
	{snake.push(circle.clone());}
	
	// Tableaux de communication client/serveur
	var onScreenSnakes = [snake];
	var allSnakes;
	var localData;
	
	function onMouseUp(event) {
		// Génération d'un vecteur entre la pos. actuelle et la pos. désirée
		vector = event.point - circle.position;
		vector.length = speed;
		
		// Envoi de la tête et du vecteur au serveur pour transmission à autres clients
		localData= [circle,vector];
		ws.send(JSON.stringify(localData));
	}
	
	// Ici, on reçoit le broadcast du serveur
	ws.onmessage = function(msg) {
			console.log('Received message from server: ' + msg.data);
			// On veut update le déplacement de tous les snakes
			allSnakes = JSON.parse(msg.data);
			
			for(var i in allSnakes)
			{
			
// ICI - allSnakes[i][0].clone() semble ne pas marcher !!
				
				// Ajouter le vecteur à la position du cercle (Déplacement tête)
				onScreenSnakes[i][0] += allSnakes[i][1];
				// Ajout d'un nouveau clone du cercle (Gestion queue n1")
				onScreenSnakes[i].push(allSnakes[i][0].clone());
				// Suppression du clone le plus ancien (Gestion queue n2")
				onScreenSnakes[i].splice(1,1)[0].remove();
			}
			
			
		}
	
</script>
<body>
 <canvas id="myCanvas" resize></canvas>
</body>
</head>
</html>